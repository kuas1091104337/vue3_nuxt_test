import{I as R,A as v,J as b,f as j,K as O,L as D,M as I,N as M,i as P,j as x}from"./C4-ekBSf.js";import{i as N}from"./wSbNHcIL.js";function _(e,i){if(typeof e!="string")throw new TypeError("argument str must be a string");const o={},t=i||{},n=t.decode||U;let a=0;for(;a<e.length;){const r=e.indexOf("=",a);if(r===-1)break;let u=e.indexOf(";",a);if(u===-1)u=e.length;else if(u<r){a=e.lastIndexOf(";",r-1)+1;continue}const c=e.slice(a,r).trim();if(t!=null&&t.filter&&!(t!=null&&t.filter(c))){a=u+1;continue}if(o[c]===void 0){let l=e.slice(r+1,u).trim();l.codePointAt(0)===34&&(l=l.slice(1,-1)),o[c]=$(l,n)}a=u+1}return o}function U(e){return e.includes("%")?decodeURIComponent(e):e}function $(e,i){try{return i(e)}catch{return e}}const g=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function A(e,i,o){const t=o||{},n=t.encode||encodeURIComponent;if(typeof n!="function")throw new TypeError("option encode is invalid");if(!g.test(e))throw new TypeError("argument name is invalid");const a=n(i);if(a&&!g.test(a))throw new TypeError("argument val is invalid");let r=e+"="+a;if(t.maxAge!==void 0&&t.maxAge!==null){const u=t.maxAge-0;if(Number.isNaN(u)||!Number.isFinite(u))throw new TypeError("option maxAge is invalid");r+="; Max-Age="+Math.floor(u)}if(t.domain){if(!g.test(t.domain))throw new TypeError("option domain is invalid");r+="; Domain="+t.domain}if(t.path){if(!g.test(t.path))throw new TypeError("option path is invalid");r+="; Path="+t.path}if(t.expires){if(!q(t.expires)||Number.isNaN(t.expires.valueOf()))throw new TypeError("option expires is invalid");r+="; Expires="+t.expires.toUTCString()}if(t.httpOnly&&(r+="; HttpOnly"),t.secure&&(r+="; Secure"),t.priority)switch(typeof t.priority=="string"?t.priority.toLowerCase():t.priority){case"low":{r+="; Priority=Low";break}case"medium":{r+="; Priority=Medium";break}case"high":{r+="; Priority=High";break}default:throw new TypeError("option priority is invalid")}if(t.sameSite)switch(typeof t.sameSite=="string"?t.sameSite.toLowerCase():t.sameSite){case!0:{r+="; SameSite=Strict";break}case"lax":{r+="; SameSite=Lax";break}case"strict":{r+="; SameSite=Strict";break}case"none":{r+="; SameSite=None";break}default:throw new TypeError("option sameSite is invalid")}return t.partitioned&&(r+="; Partitioned"),r}function q(e){return Object.prototype.toString.call(e)==="[object Date]"||e instanceof Date}function f(e){if(typeof e!="object")return e;var i,o,t=Object.prototype.toString.call(e);if(t==="[object Object]"){if(e.constructor!==Object&&typeof e.constructor=="function"){o=new e.constructor;for(i in e)e.hasOwnProperty(i)&&o[i]!==e[i]&&(o[i]=f(e[i]))}else{o={};for(i in e)i==="__proto__"?Object.defineProperty(o,i,{value:f(e[i]),configurable:!0,enumerable:!0,writable:!0}):o[i]=f(e[i])}return o}if(t==="[object Array]"){for(i=e.length,o=Array(i);i--;)o[i]=f(e[i]);return o}return t==="[object Set]"?(o=new Set,e.forEach(function(n){o.add(f(n))}),o):t==="[object Map]"?(o=new Map,e.forEach(function(n,a){o.set(f(a),f(n))}),o):t==="[object Date]"?new Date(+e):t==="[object RegExp]"?(o=new RegExp(e.source,e.flags),o.lastIndex=e.lastIndex,o):t==="[object DataView]"?new e.constructor(f(e.buffer)):t==="[object ArrayBuffer]"?e.slice(0):t.slice(-6)==="Array]"?new e.constructor(e):e}const z={path:"/",watch:!0,decode:e=>R(decodeURIComponent(e)),encode:e=>encodeURIComponent(typeof e=="string"?e:JSON.stringify(e))},y=window.cookieStore;function B(e,i){var l;const o={...z,...i};o.filter??(o.filter=s=>s===e);const t=C(o)||{};let n;o.maxAge!==void 0?n=o.maxAge*1e3:o.expires&&(n=o.expires.getTime()-Date.now());const a=n!==void 0&&n<=0,r=a||t[e]===void 0||t[e]===null,u=f(a?void 0:t[e]??((l=o.default)==null?void 0:l.call(o))),c=n&&!a?V(u,n,o.watch&&o.watch!=="shallow"):v(u);{let s=null;try{!y&&typeof BroadcastChannel<"u"&&(s=new BroadcastChannel(`nuxt:cookies:${e}`))}catch{}const d=(p=!1)=>{!p&&(o.readonly||N(c.value,t[e]))||(H(e,c.value,o),t[e]=f(c.value),s==null||s.postMessage({value:o.encode(c.value)}))},k=p=>{var m;const h=p.refresh?(m=C(o))==null?void 0:m[e]:o.decode(p.value);w=!0,c.value=h,t[e]=f(h),I(()=>{w=!1})};let w=!1;const E=!!O();if(E&&b(()=>{w=!0,d(),s==null||s.close()}),y){const p=h=>{const m=h.changed.find(S=>S.name===e),L=h.deleted.find(S=>S.name===e);m&&k({value:m.value}),L&&k({value:null})};y.addEventListener("change",p),E&&b(()=>y.removeEventListener("change",p))}else s&&(s.onmessage=({data:p})=>k(p));o.watch&&j(c,()=>{w||d()},{deep:o.watch!=="shallow"}),r&&d(r)}return c}function C(e={}){return _(document.cookie,e)}function F(e,i,o={}){return i==null?A(e,i,{...o,maxAge:-1}):A(e,i,o)}function H(e,i,o={}){document.cookie=F(e,i,o)}const T=2147483647;function V(e,i,o){let t,n,a=0;const r=o?v(e):{value:e};return O()&&b(()=>{n==null||n(),clearTimeout(t)}),D((u,c)=>{o&&(n=j(r,c));function l(){a=0,clearTimeout(t);const s=i-a,d=s<T?s:T;t=setTimeout(()=>{if(a+=d,a<i)return l();r.value=void 0,c()},d)}return{get(){return u(),r.value},set(s){l(),r.value=s,c()}}})}const X=M("login",()=>{const e=B("token",{maxAge:604800}),i=P(),o=x(),t=v(!1),n=v({username:"",password:""});return{isLoading:t,handleLoading:()=>t.value=!t.value,sendLoginAuth:async({username:c,password:l})=>{if(!t.value){t.value=!0;try{const s=await $fetch("https://vue-lessons-api.vercel.app/auth/login",{method:"POST",body:{username:c,password:l}});e.value={token:s.data.token},o.replace("/vip")}catch(s){const{username:d}=s.response._data.errorMsg;n.value={username:d,password:"password error"}}finally{t.value=!1}}},checkAuth:async()=>{var c,l;try{await $fetch("https://vue-lessons-api.vercel.app/testToken",{method:"POST",headers:{Authorization:(c=e.value)==null?void 0:c.token}}),o.replace("/vip"),console.log("驗證成功")}catch(s){if(((l=s.response)==null?void 0:l.status)===403){e.value=null;const{query:d}=i;console.error("驗證失敗",s),o.replace("/login")}}},errorMsg:n}});export{B as a,X as u};
